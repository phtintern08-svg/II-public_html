<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Email - Impromptu Indian</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f131a 0%, #1a1f2e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #ffd43b;
        }
        
        .message {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 30px;
            color: #e0e0e0;
        }
        
        .success {
            color: #4ade80;
        }
        
        .error {
            color: #f87171;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #ffd43b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #ffd43b;
            color: #000;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 20px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #e6be35;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="title">Verifying your email‚Ä¶</h2>
        <div id="spinner" class="spinner"></div>
        <div id="message" class="message hidden"></div>
        <a href="login.html" id="loginLink" class="btn hidden">Go to Login</a>
        <a href="#" id="backBtn" class="btn hidden">Go to Registration</a>
    </div>

    <script>
        // ‚úÖ FIX: Wrap entire script in IIFE to allow return statements
        (function () {
            // Set API base URL (multi-domain safe)
            // If this page is opened on a different host, force API calls to the Passenger app host.
            (function ensureApiBase() {
                const host = (window.location.hostname || '').toLowerCase();
                const isLocal = host === 'localhost' || host === '127.0.0.1';
                if (!isLocal && host.endsWith('impromptuindian.com')) {
                    window.IMPROMPTU_INDIAN_API_BASE = 'https://apparels.impromptuindian.com';
                } else {
                    window.IMPROMPTU_INDIAN_API_BASE = window.IMPROMPTU_INDIAN_API_BASE || '';
                }
            })();
            
            // ‚úÖ FIX #1: Poll until verification is complete (short-lived, ~10 seconds max)
            // Frontend needs confirmation loop because redirect params may not be immediately available
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const verified = urlParams.get('verified');
            const titleEl = document.getElementById('title');
            const messageEl = document.getElementById('message');
            const spinnerEl = document.getElementById('spinner');
            const loginLinkEl = document.getElementById('loginLink');
            const backBtnEl = document.getElementById('backBtn');
            
            // Store email/role for button click handler
            let verifiedEmail = null;
            let verifiedRole = null;
            
            // ‚úÖ Improvement 1: Guard flag to prevent duplicate polling after success
            let verificationDone = false;

        // ‚úÖ Check for error params first (expired link from backend redirect)
        const errorParam = urlParams.get('error');
        const reasonParam = urlParams.get('reason');
        
        if (errorParam === 'expired') {
            spinnerEl.classList.add('hidden');
            titleEl.textContent = 'Link Expired';
            titleEl.classList.remove('success');
            titleEl.classList.add('error');
            messageEl.textContent = 'This verification link has expired. Please request a new verification email.';
            messageEl.classList.remove('hidden');
            messageEl.classList.add('error');
            loginLinkEl.textContent = 'Go to Registration';
            loginLinkEl.href = 'register.html';
            loginLinkEl.classList.remove('hidden');
            console.log('‚õî Verification link expired:', reasonParam || 'unknown');
            return;
        }

        // ‚úÖ OPTIMIZATION: If already verified via redirect params, skip polling
        if (verified === '1' || verified === 'true') {
            console.log('üîÅ Email verification confirmed via redirect params');
            const email = urlParams.get('email');
            const role = urlParams.get('role');
            
            // Store for button click handler
            verifiedEmail = email;
            verifiedRole = role;
            
            spinnerEl.classList.add('hidden');
            titleEl.textContent = 'Email Verified ‚úî';
            titleEl.classList.remove('error');
            titleEl.classList.add('success');
            messageEl.textContent = 'Your email has been verified successfully. Click the button below to continue.';
            messageEl.classList.remove('hidden');
            messageEl.classList.add('success');

            // ‚úÖ FIX #3: Cross-tab sync with forced storage event
            if (email && role) {
                const syncData = JSON.stringify({
                    email: email,
                    role: role,
                    ts: Date.now()
                });
                localStorage.setItem('email_verified', syncData);
                
                // üî• Force storage event in same tab too (storage events don't fire in same tab)
                window.dispatchEvent(
                    new StorageEvent('storage', {
                        key: 'email_verified',
                        newValue: syncData,
                        storageArea: localStorage
                    })
                );
                
                // ‚úÖ FIX #4: Show manual "Go to Registration" button
                if (backBtnEl) {
                    backBtnEl.classList.remove('hidden');
                }
                
                // ‚úÖ Improvement 2: Clear token from URL (security + cleanliness)
                // Prevents copy/paste of old token URLs, cleaner UX, matches banking apps behavior
                if (window.history && window.history.replaceState) {
                    const cleanUrl = window.location.pathname + '?verified=1&email=' +
                        encodeURIComponent(email) + '&role=' + encodeURIComponent(role);
                    window.history.replaceState({}, document.title, cleanUrl);
                }
            }

            // ‚úÖ PART 1: No auto-redirect - user must click button manually
            return;
        }

        if (!token) {
            spinnerEl.classList.add('hidden');
            titleEl.textContent = 'Verification Failed';
            titleEl.classList.remove('success');
            titleEl.classList.add('error');
            messageEl.textContent = 'Invalid verification link. Please check your email and try again.';
            messageEl.classList.remove('hidden');
            messageEl.classList.add('error');
            loginLinkEl.textContent = 'Go to Registration';
            loginLinkEl.href = 'register.html';
            loginLinkEl.classList.remove('hidden');
            return;
        }

        let attempts = 0;
        const MAX_ATTEMPTS = 10; // ~10 seconds (1 second intervals)

        async function pollVerification() {
            attempts++;
            // ‚úÖ Optional: Log polling attempts (debug-only)
            console.log(`‚è≥ Polling verification attempt ${attempts}/${MAX_ATTEMPTS}`);

            try {
                const apiBase = window.IMPROMPTU_INDIAN_API_BASE || '';
                const res = await fetch(`${apiBase}/api/verify-email?token=${encodeURIComponent(token)}`, {
                    headers: { 
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'  // ‚úÖ FIX #2: Explicit API request marker
                    }
                });

                // ‚úÖ FIX #2.1: Harden polling - check content type before parsing JSON
                // Continue polling on non-JSON responses (could be 204, 401, 500, or HTML error)
                // Only stop on success or timeout
                const contentType = res.headers.get('content-type') || '';
                
                if (!contentType.includes('application/json')) {
                    // Non-JSON response (redirect, error page, etc.) - continue polling if attempts remain
                    if (attempts < MAX_ATTEMPTS) {
                        setTimeout(pollVerification, 1000);
                    }
                    return;
                }

                const data = await res.json();

                // ‚úÖ PART 3: Handle expired link errors
                if (!data.success && data.error === 'Link expired') {
                    spinnerEl.classList.add('hidden');
                    titleEl.textContent = 'Link Expired';
                    titleEl.classList.remove('success');
                    titleEl.classList.add('error');
                    messageEl.textContent = 'This verification link has expired. Please request a new verification email.';
                    messageEl.classList.remove('hidden');
                    messageEl.classList.add('error');
                    loginLinkEl.textContent = 'Go to Registration';
                    loginLinkEl.href = 'register.html';
                    loginLinkEl.classList.remove('hidden');
                    console.log('‚õî Verification link expired:', data.reason || 'unknown');
                    return;
                }

                if (data.success) {
                    // ‚úÖ Improvement 1: Stop polling after success (race guard)
                    if (verificationDone) return;
                    verificationDone = true;
                    
                    // ‚úÖ Log verification source (DB-confirmed)
                    console.log('‚úÖ Email verification confirmed from database');
                    
                    // Store for button click handler
                    verifiedEmail = data.email;
                    verifiedRole = data.role;
                    
                    // ‚úÖ VERIFIED - Show success and sync across tabs
                    spinnerEl.classList.add('hidden');
                    titleEl.textContent = 'Email Verified ‚úî';
                    titleEl.classList.remove('error');
                    titleEl.classList.add('success');

                    // ‚úÖ FIX #4: Improved UX messaging
                    messageEl.innerHTML = `
                        <div style="font-size:18px;margin-bottom:10px">‚úÖ Verification Complete</div>
                        <div>You can safely return to the registration page.</div>
                    `;
                    messageEl.classList.remove('hidden');
                    messageEl.classList.add('success');

                    // ‚úÖ FIX #3: Cross-tab sync with forced storage event
                    if (data.email && data.role) {
                        const syncData = JSON.stringify({
                            email: data.email,
                            role: data.role,
                            ts: Date.now()
                        });
                        localStorage.setItem('email_verified', syncData);
                        
                        // üî• Force storage event in same tab too (storage events don't fire in same tab)
                        window.dispatchEvent(
                            new StorageEvent('storage', {
                                key: 'email_verified',
                                newValue: syncData,
                                storageArea: localStorage
                            })
                        );
                        
                        // ‚úÖ FIX #4: Show manual "Go to Registration" button
                        if (backBtnEl) {
                            backBtnEl.classList.remove('hidden');
                        }
                    }
                    
                    // ‚úÖ Improvement 2: Clear token from URL (security + cleanliness)
                    // Prevents copy/paste of old token URLs, cleaner UX, matches banking apps behavior
                    if (window.history && window.history.replaceState) {
                        const cleanUrl = window.location.pathname + '?verified=1&email=' +
                            encodeURIComponent(verifiedEmail) + '&role=' + encodeURIComponent(verifiedRole);
                        window.history.replaceState({}, document.title, cleanUrl);
                    }

                    // ‚úÖ PART 1: No auto-redirect - user must click button manually

                    return;
                }

            } catch (e) {
                console.error('Verification polling error:', e);
            }

            // Continue polling if not verified yet
            if (attempts < MAX_ATTEMPTS) {
                setTimeout(pollVerification, 1000); // Poll every 1 second
            } else {
                // Timeout - show error
                spinnerEl.classList.add('hidden');
                titleEl.textContent = 'Verification Timeout';
                titleEl.classList.remove('success');
                titleEl.classList.add('error');
                messageEl.textContent = 'Verification timed out. Please try again or request a new verification link.';
                messageEl.classList.remove('hidden');
                messageEl.classList.add('error');
                loginLinkEl.textContent = 'Go to Registration';
                loginLinkEl.href = 'register.html';
                loginLinkEl.classList.remove('hidden');
            }
        }

        // Start polling immediately
        pollVerification();
        
        // ‚úÖ FINAL FIX: Direct navigation with state restoration (industry standard)
        // DO NOT use history.back() - use location.replace() for clean UX
        if (backBtnEl) {
            backBtnEl.addEventListener('click', (e) => {
                e.preventDefault();
                
                const email = verifiedEmail || urlParams.get('email');
                const role = verifiedRole || urlParams.get('role');
                
                console.log('‚û°Ô∏è Redirecting to registration with verified email');
                
                if (email && role) {
                    const target =
                        role === 'rider'
                            ? `rider-register.html?email=${encodeURIComponent(email)}&role=${role}`
                            : `register.html?email=${encodeURIComponent(email)}&role=${role}`;
                    
                    // ‚úÖ IMPORTANT: replace(), not href
                    // Prevents going back to verify page, prevents token reuse confusion, clean browser history
                    window.location.replace(target);
                } else {
                    window.location.replace('register.html');
                }
            });
        }
        })(); // ‚úÖ End of IIFE - now return statements are valid
    </script>
</body>
</html>
