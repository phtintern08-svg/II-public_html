# Allow API POSTs through ModSecurity
<IfModule mod_security2.c>
    SecRuleRemoveById 949110
    SecRuleRemoveById 920350
    SecRuleRemoveById 920420
    SecRuleRemoveById 930120
    SecRuleRemoveById 942100
    SecRuleRemoveById 942110
    SecRuleRemoveById 942200
    SecRuleRemoveById 942260
</IfModule>

# ================================
# Passenger Python App Config
# ================================

PassengerEnabled on
PassengerAppRoot /home/impromptuindian/Backend
PassengerBaseURI /
PassengerPython /home/impromptuindian/virtualenv/Backend/3.13/bin/python

PassengerLogFile /home/impromptuindian/logs/stderr.log
PassengerStdoutLogFile /home/impromptuindian/logs/stdout.log
PassengerFriendlyErrorPages off
PassengerShowVersionInHeader off

# ===============================
# Impromptu Indian â€“ Flask + SPA
# ===============================

RewriteEngine On

# -------------------------------------------------
# 1. Disable ModSecurity (WAF) for JSON APIs
# -------------------------------------------------
<IfModule mod_security2.c>
    SecRuleEngine Off
</IfModule>

<IfModule mod_security.c>
    SecFilterEngine Off
    SecFilterScanPOST Off
</IfModule>

# -------------------------------------------------
# 2. Let Flask handle all API endpoints
# -------------------------------------------------
# These must NEVER be rewritten to index.html
RewriteRule ^/?api/authenticate$ - [L]
RewriteRule ^/?(login|register|send-otp|verify-otp|api)(/.*)?$ - [L]

# -------------------------------------------------
# 3. Never rewrite POST/PUT/PATCH/DELETE requests
# -------------------------------------------------
RewriteCond %{REQUEST_METHOD} ^(POST|PUT|PATCH|DELETE)$
RewriteRule ^ - [L]

# -------------------------------------------------
# 4. Serve real files and folders directly
# -------------------------------------------------
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# -------------------------------------------------
# 5. SPA Routing (GET requests only)
# -------------------------------------------------
RewriteCond %{REQUEST_METHOD} GET
RewriteCond %{REQUEST_URI} !^/(login|register|send-otp|verify-otp|api)
RewriteRule ^ index.html [L]
# -------------------------------------------------
# 6. Security headers
# -------------------------------------------------
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# -------------------------------------------------
# 7. Block sensitive files
# -------------------------------------------------
<FilesMatch "\.(env|pyc|log|sql|md|bak|tmp)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# -------------------------------------------------
# 8. Allow static assets
# -------------------------------------------------
<FilesMatch "\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|mp4|webp|pdf)$">
    Order allow,deny
    Allow from all
</FilesMatch>

# -------------------------------------------------
# 9. Compression
# -------------------------------------------------
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/css text/javascript application/javascript application/json
</IfModule>

